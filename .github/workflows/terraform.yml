name: Terraform Infrastructure

on:
  # Run after CI passes (recommended - ensures code is validated first)
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches:
      - develop
      - staging
      - main
  # Also allow direct push (for flexibility)
  push:
    branches:
      - develop
      - staging
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform.yml'
  pull_request:
    branches:
      - develop
      - staging
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy (dev/staging/prod)'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.13.3

jobs:
  # ============================================
  # Terraform Plan
  # ============================================
  
  terraform-plan:
    name: Terraform Plan - ${{ github.ref_name }}
    runs-on: ubuntu-latest
    # Only run if CI passed (when triggered by workflow_run)
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    outputs:
      run_id: ${{ github.run_id }}
      plan_success: ${{ steps.plan.outputs.plan_success }}
    permissions:
      contents: read
      id-token: write  # Required for OIDC
    steps:
      - name: Check CI Status (if triggered by workflow_run)
        if: github.event_name == 'workflow_run'
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "❌ CI Pipeline failed. Skipping Terraform plan."
            echo "CI Conclusion: ${{ github.event.workflow_run.conclusion }}"
            exit 1
          fi
          echo "✅ CI Pipeline passed. Proceeding with Terraform plan."
      
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set AWS role ARN
        id: aws-role
        run: |
          if [ -n "${{ secrets.AWS_TERRAFORM_ROLE_ARN }}" ]; then
            echo "role_arn=${{ secrets.AWS_TERRAFORM_ROLE_ARN }}" >> $GITHUB_OUTPUT
            echo "use_oidc=true" >> $GITHUB_OUTPUT
          else
            echo "use_oidc=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false
      
      - name: Configure AWS credentials (OIDC)
        if: steps.aws-role.outputs.use_oidc == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.aws-role.outputs.role_arn }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: terraform-plan-${{ github.run_id }}
      
      - name: Configure AWS credentials (Access Keys)
        if: steps.aws-role.outputs.use_oidc == 'false'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Select environment
        id: env
        run: |
          if [[ "${{ github.event.inputs.environment }}" != "" ]]; then
            ENV_NAME="${{ github.event.inputs.environment }}"
          elif [[ "${{ github.ref_name }}" == "develop" ]]; then
            ENV_NAME="dev"
          elif [[ "${{ github.ref_name }}" == "staging" ]]; then
            ENV_NAME="staging"
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            ENV_NAME="prod"
          else
            ENV_NAME="dev"
          fi
          echo "ENV_NAME=$ENV_NAME" >> $GITHUB_OUTPUT
          echo "Selected environment: $ENV_NAME"
      
      - name: Terraform Format Check
        working-directory: terraform/envs/${{ steps.env.outputs.ENV_NAME }}
        run: terraform fmt -check -recursive
        continue-on-error: true
      
      - name: Terraform Init
        working-directory: terraform/envs/${{ steps.env.outputs.ENV_NAME }}
        run: terraform init -input=false -upgrade
      
      - name: Terraform Validate
        working-directory: terraform/envs/${{ steps.env.outputs.ENV_NAME }}
        run: terraform validate
      
      - name: Terraform Plan
        id: plan
        working-directory: terraform/envs/${{ steps.env.outputs.ENV_NAME }}
        run: |
          # Use tfvars file if it exists, otherwise use defaults
          PLAN_EXIT_CODE=0
          if [ -f terraform.tfvars ]; then
            terraform plan -input=false -var-file=terraform.tfvars -out=tfplan || PLAN_EXIT_CODE=$?
          else
            terraform plan -input=false -out=tfplan || PLAN_EXIT_CODE=$?
          fi
          
          # Only create plan.txt if plan succeeded
          if [ $PLAN_EXIT_CODE -eq 0 ]; then
            terraform show -no-color tfplan > plan.txt
            echo "plan_success=true" >> $GITHUB_OUTPUT
            echo "✅ Plan created successfully"
          else
            echo "plan_success=false" >> $GITHUB_OUTPUT
            echo "❌ Plan failed with exit code $PLAN_EXIT_CODE"
            # Remove incomplete plan file
            rm -f tfplan
          fi
          echo "plan_exit_code=$PLAN_EXIT_CODE" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Upload Plan and Lock File
        if: steps.plan.outputs.plan_success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ steps.env.outputs.ENV_NAME }}-${{ github.run_id }}
          path: |
            terraform/envs/${{ steps.env.outputs.ENV_NAME }}/tfplan
            terraform/envs/${{ steps.env.outputs.ENV_NAME }}/.terraform.lock.hcl
          retention-days: 7
      
      - name: Set Plan Run ID
        if: steps.plan.outputs.plan_success == 'true'
        id: plan-run-id
        run: |
          echo "run_id=${{ github.run_id }}" >> $GITHUB_OUTPUT
          echo "artifact_name=tfplan-${{ steps.env.outputs.ENV_NAME }}-${{ github.run_id }}" >> $GITHUB_OUTPUT
      
      - name: Comment PR with Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const planPath = 'terraform/envs/${{ steps.env.outputs.ENV_NAME }}/plan.txt';
            let planOutput = '## Terraform Plan Results\n\n';
            
            if (fs.existsSync(planPath)) {
              const plan = fs.readFileSync(planPath, 'utf8');
              planOutput += '```\n' + plan + '\n```';
            } else {
              planOutput += '⚠️ Plan file not found. Check workflow logs for details.';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: planOutput
            });

  # ============================================
  # Terraform Apply (Dev - Auto)
  # ============================================
  
  terraform-apply-dev:
    name: Terraform Apply - Dev
    runs-on: ubuntu-latest
    needs: [terraform-plan]
    if: |
      github.ref_name == 'develop' &&
      github.event_name == 'push' &&
      needs.terraform-plan.outputs.plan_exit_code == '0'
    environment:
      name: development
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set AWS role ARN
        id: aws-role
        run: |
          if [ -n "${{ secrets.AWS_TERRAFORM_ROLE_ARN }}" ]; then
            echo "role_arn=${{ secrets.AWS_TERRAFORM_ROLE_ARN }}" >> $GITHUB_OUTPUT
            echo "use_oidc=true" >> $GITHUB_OUTPUT
          else
            echo "use_oidc=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Configure AWS credentials (OIDC)
        if: steps.aws-role.outputs.use_oidc == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.aws-role.outputs.role_arn }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: terraform-apply-dev-${{ github.run_id }}
      
      - name: Configure AWS credentials (Access Keys)
        if: steps.aws-role.outputs.use_oidc == 'false'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Download Plan and Lock File
        id: download-plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-dev-${{ needs.terraform-plan.outputs.run_id }}
          path: terraform/envs/dev
        continue-on-error: true
      
      - name: Check if Plan Artifact Exists
        id: plan-exists
        run: |
          if [ -f terraform/envs/dev/tfplan ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "✅ Plan artifact found"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ Plan artifact not found, will create fresh plan"
          fi
      
      - name: Terraform Init
        working-directory: terraform/envs/dev
        run: terraform init -input=false -upgrade
      
      - name: Verify Plan File
        id: verify-plan
        if: steps.plan-exists.outputs.exists == 'true'
        working-directory: terraform/envs/dev
        run: |
          # Check if plan file exists and is complete
          if [ ! -f tfplan ]; then
            echo "plan_valid=false" >> $GITHUB_OUTPUT
            echo "⚠️ Plan file not found, will create new plan"
            exit 0
          fi
          
          # Check if plan can be shown (basic validation)
          if ! terraform show tfplan > /dev/null 2>&1; then
            echo "plan_valid=false" >> $GITHUB_OUTPUT
            echo "⚠️ Plan file is invalid, will create new plan"
            exit 0
          fi
          
          # Check if plan is complete (not incomplete)
          PLAN_OUTPUT=$(terraform show -json tfplan 2>/dev/null)
          if echo "$PLAN_OUTPUT" | grep -q '"format_version":"1.0"' && ! echo "$PLAN_OUTPUT" | grep -q '"incomplete":true'; then
            echo "plan_valid=true" >> $GITHUB_OUTPUT
            echo "✅ Plan file is valid and complete"
          else
            echo "plan_valid=false" >> $GITHUB_OUTPUT
            echo "⚠️ Plan file is incomplete, will create new plan"
          fi
        continue-on-error: true
      
      - name: Set Plan Valid (if artifact missing)
        if: steps.plan-exists.outputs.exists == 'false'
        id: verify-plan-fallback
        run: |
          echo "plan_valid=false" >> $GITHUB_OUTPUT
          echo "⚠️ Plan artifact not found, will create fresh plan"
      
      - name: Terraform Apply (with saved plan)
        if: steps.verify-plan.outputs.plan_valid == 'true'
        working-directory: terraform/envs/dev
        run: terraform apply -input=false -auto-approve tfplan
      
      - name: Terraform Apply (fresh plan)
        if: steps.verify-plan.outputs.plan_valid != 'true' || steps.plan-exists.outputs.exists == 'false'
        working-directory: terraform/envs/dev
        run: |
          if [ -f terraform.tfvars ]; then
            terraform plan -input=false -var-file=terraform.tfvars -out=tfplan-fresh
          else
            terraform plan -input=false -out=tfplan-fresh
          fi
          terraform apply -input=false -auto-approve tfplan-fresh
      
      - name: Get Terraform Outputs
        id: outputs
        working-directory: terraform/envs/dev
        run: |
          echo "alb_dns=$(terraform output -raw alb_dns_name)" >> $GITHUB_OUTPUT
          echo "ecr_url=$(terraform output -raw ecr_repository_url)" >> $GITHUB_OUTPUT
          echo "cluster_name=$(terraform output -raw ecs_cluster_name)" >> $GITHUB_OUTPUT
          echo "service_name=$(terraform output -raw ecs_service_name)" >> $GITHUB_OUTPUT

  # ============================================
  # Terraform Apply (Staging/Prod - Manual)
  # ============================================
  
  terraform-apply-staging:
    name: Terraform Apply - Staging
    runs-on: ubuntu-latest
    needs: [terraform-plan]
    if: |
      (github.ref_name == 'staging' || github.event.inputs.environment == 'staging') &&
      github.event_name == 'push' &&
      needs.terraform-plan.outputs.plan_exit_code == '0'
    environment:
      name: staging
      url: https://staging.yourdomain.com  # Update with your domain
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set AWS role ARN
        id: aws-role
        run: |
          if [ -n "${{ secrets.AWS_TERRAFORM_ROLE_ARN }}" ]; then
            echo "role_arn=${{ secrets.AWS_TERRAFORM_ROLE_ARN }}" >> $GITHUB_OUTPUT
            echo "use_oidc=true" >> $GITHUB_OUTPUT
          else
            echo "use_oidc=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Configure AWS credentials (OIDC)
        if: steps.aws-role.outputs.use_oidc == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.aws-role.outputs.role_arn }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: terraform-apply-staging-${{ github.run_id }}
      
      - name: Configure AWS credentials (Access Keys)
        if: steps.aws-role.outputs.use_oidc == 'false'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Download Plan and Lock File
        id: download-plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-staging-${{ needs.terraform-plan.outputs.run_id }}
          path: terraform/envs/staging
        continue-on-error: true
      
      - name: Check if Plan Artifact Exists
        id: plan-exists
        run: |
          if [ -f terraform/envs/staging/tfplan ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "✅ Plan artifact found"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ Plan artifact not found, will create fresh plan"
          fi
      
      - name: Terraform Init
        working-directory: terraform/envs/staging
        run: terraform init -input=false -upgrade
      
      - name: Verify Plan File
        id: verify-plan
        if: steps.plan-exists.outputs.exists == 'true'
        working-directory: terraform/envs/staging
        run: |
          # Check if plan file exists and is complete
          if [ ! -f tfplan ]; then
            echo "plan_valid=false" >> $GITHUB_OUTPUT
            echo "⚠️ Plan file not found, will create new plan"
            exit 0
          fi
          
          # Check if plan can be shown (basic validation)
          if ! terraform show tfplan > /dev/null 2>&1; then
            echo "plan_valid=false" >> $GITHUB_OUTPUT
            echo "⚠️ Plan file is invalid, will create new plan"
            exit 0
          fi
          
          # Check if plan is complete (not incomplete)
          PLAN_OUTPUT=$(terraform show -json tfplan 2>/dev/null)
          if echo "$PLAN_OUTPUT" | grep -q '"format_version":"1.0"' && ! echo "$PLAN_OUTPUT" | grep -q '"incomplete":true'; then
            echo "plan_valid=true" >> $GITHUB_OUTPUT
            echo "✅ Plan file is valid and complete"
          else
            echo "plan_valid=false" >> $GITHUB_OUTPUT
            echo "⚠️ Plan file is incomplete, will create new plan"
          fi
        continue-on-error: true
      
      - name: Set Plan Valid (if artifact missing)
        if: steps.plan-exists.outputs.exists == 'false'
        id: verify-plan-fallback
        run: |
          echo "plan_valid=false" >> $GITHUB_OUTPUT
          echo "⚠️ Plan artifact not found, will create fresh plan"
      
      - name: Terraform Apply (with saved plan)
        if: steps.verify-plan.outputs.plan_valid == 'true'
        working-directory: terraform/envs/staging
        run: terraform apply -input=false -auto-approve tfplan
      
      - name: Terraform Apply (fresh plan)
        if: steps.verify-plan.outputs.plan_valid != 'true' || steps.plan-exists.outputs.exists == 'false'
        working-directory: terraform/envs/staging
        run: |
          if [ -f terraform.tfvars ]; then
            terraform plan -input=false -var-file=terraform.tfvars -out=tfplan-fresh
          else
            terraform plan -input=false -out=tfplan-fresh
          fi
          terraform apply -input=false -auto-approve tfplan-fresh
      
      - name: Get Terraform Outputs
        id: outputs
        working-directory: terraform/envs/staging
        run: |
          echo "alb_dns=$(terraform output -raw alb_dns_name)" >> $GITHUB_OUTPUT
          echo "ecr_url=$(terraform output -raw ecr_repository_url)" >> $GITHUB_OUTPUT
          echo "cluster_name=$(terraform output -raw ecs_cluster_name)" >> $GITHUB_OUTPUT
          echo "service_name=$(terraform output -raw ecs_service_name)" >> $GITHUB_OUTPUT

  terraform-apply-prod:
    name: Terraform Apply - Production
    runs-on: ubuntu-latest
    needs: [terraform-plan]
    if: |
      (github.ref_name == 'main' || github.event.inputs.environment == 'prod') &&
      github.event_name == 'push' &&
      needs.terraform-plan.outputs.plan_exit_code == '0'
    environment:
      name: production
      url: https://yourdomain.com  # Update with your domain
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set AWS role ARN
        id: aws-role
        run: |
          if [ -n "${{ secrets.AWS_TERRAFORM_ROLE_ARN }}" ]; then
            echo "role_arn=${{ secrets.AWS_TERRAFORM_ROLE_ARN }}" >> $GITHUB_OUTPUT
            echo "use_oidc=true" >> $GITHUB_OUTPUT
          else
            echo "use_oidc=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Configure AWS credentials (OIDC)
        if: steps.aws-role.outputs.use_oidc == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.aws-role.outputs.role_arn }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: terraform-apply-prod-${{ github.run_id }}
      
      - name: Configure AWS credentials (Access Keys)
        if: steps.aws-role.outputs.use_oidc == 'false'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Download Plan and Lock File
        id: download-plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-prod-${{ needs.terraform-plan.outputs.run_id }}
          path: terraform/envs/prod
        continue-on-error: true
      
      - name: Check if Plan Artifact Exists
        id: plan-exists
        run: |
          if [ -f terraform/envs/prod/tfplan ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "✅ Plan artifact found"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ Plan artifact not found (may be from different workflow run), will create fresh plan"
          fi
      
      - name: Terraform Init
        working-directory: terraform/envs/prod
        run: terraform init -input=false -upgrade
      
      - name: Verify Plan File
        id: verify-plan
        if: steps.plan-exists.outputs.exists == 'true'
        working-directory: terraform/envs/prod
        run: |
          # Check if plan file exists and is complete
          if [ ! -f tfplan ]; then
            echo "plan_valid=false" >> $GITHUB_OUTPUT
            echo "⚠️ Plan file not found, will create new plan"
            exit 0
          fi
          
          # Check if plan can be shown (basic validation)
          if ! terraform show tfplan > /dev/null 2>&1; then
            echo "plan_valid=false" >> $GITHUB_OUTPUT
            echo "⚠️ Plan file is invalid, will create new plan"
            exit 0
          fi
          
          # Check if plan is complete (not incomplete)
          PLAN_OUTPUT=$(terraform show -json tfplan 2>/dev/null)
          if echo "$PLAN_OUTPUT" | grep -q '"format_version":"1.0"' && ! echo "$PLAN_OUTPUT" | grep -q '"incomplete":true'; then
            echo "plan_valid=true" >> $GITHUB_OUTPUT
            echo "✅ Plan file is valid and complete"
          else
            echo "plan_valid=false" >> $GITHUB_OUTPUT
            echo "⚠️ Plan file is incomplete, will create new plan"
          fi
        continue-on-error: true
      
      - name: Set Plan Valid (if artifact missing)
        if: steps.plan-exists.outputs.exists == 'false'
        id: verify-plan-fallback
        run: |
          echo "plan_valid=false" >> $GITHUB_OUTPUT
          echo "⚠️ Plan artifact not found, will create fresh plan"
      
      - name: Terraform Apply (with saved plan)
        if: steps.verify-plan.outputs.plan_valid == 'true'
        working-directory: terraform/envs/prod
        run: terraform apply -input=false -auto-approve tfplan
      
      - name: Terraform Apply (fresh plan)
        if: steps.verify-plan.outputs.plan_valid != 'true' || steps.plan-exists.outputs.exists == 'false'
        working-directory: terraform/envs/prod
        run: |
          if [ -f terraform.tfvars ]; then
            terraform plan -input=false -var-file=terraform.tfvars -out=tfplan-fresh
          else
            terraform plan -input=false -out=tfplan-fresh
          fi
          terraform apply -input=false -auto-approve tfplan-fresh
      
      - name: Get Terraform Outputs
        id: outputs
        working-directory: terraform/envs/prod
        run: |
          echo "alb_dns=$(terraform output -raw alb_dns_name)" >> $GITHUB_OUTPUT
          echo "ecr_url=$(terraform output -raw ecr_repository_url)" >> $GITHUB_OUTPUT
          echo "cluster_name=$(terraform output -raw ecs_cluster_name)" >> $GITHUB_OUTPUT
          echo "service_name=$(terraform output -raw ecs_service_name)" >> $GITHUB_OUTPUT

