name: Deploy to Development

on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (use with caution)'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: us-east-1
  ENVIRONMENT: dev
  ECR_REPOSITORY: omolaso-portfolio

jobs:
  # ============================================
  # Pre-deployment Checks
  # ============================================
  
  pre-deploy-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run pre-deployment script
        run: npm run predeploy

  # ============================================
  # Build & Push Docker Image
  # ============================================
  
  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks]
    if: always() && (needs.pre-deploy-checks.result == 'success' || github.event.inputs.skip_tests == 'true')
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=dev-latest,enable={{is_default_branch}}
      
      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # ============================================
  # Deploy Infrastructure (Terraform)
  # ============================================
  
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [build-and-push]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false
      
      - name: Terraform Init
        run: |
          cd terraform
          terraform init
      
      - name: Terraform Plan
        id: plan
        run: |
          cd terraform
          terraform plan \
            -var="environment=${{ env.ENVIRONMENT }}" \
            -out=tfplan
      
      - name: Save Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: terraform/tfplan
          retention-days: 1

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [terraform-plan]
    environment:
      name: development
      url: https://dev.yourdomain.com  # Update with your domain
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
      
      - name: Download Terraform Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          path: terraform
      
      - name: Terraform Apply
        run: |
          cd terraform
          terraform apply -auto-approve tfplan
      
      - name: Get Terraform Outputs
        id: terraform-outputs
        run: |
          cd terraform
          echo "ecr_url=$(terraform output -raw ecr_repository_url)" >> $GITHUB_OUTPUT
          echo "cluster_name=$(terraform output -raw ecs_cluster_name)" >> $GITHUB_OUTPUT
          echo "service_name=$(terraform output -raw ecs_service_name)" >> $GITHUB_OUTPUT
          echo "alb_dns=$(terraform output -raw alb_dns_name)" >> $GITHUB_OUTPUT

  # ============================================
  # Deploy Application (ECS)
  # ============================================
  
  deploy-ecs:
    name: Deploy to ECS
    runs-on: ubuntu-latest
    needs: [terraform-apply, build-and-push]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Get Terraform Outputs
        id: terraform-outputs
        run: |
          cd terraform
          echo "cluster_name=$(terraform output -raw ecs_cluster_name)" >> $GITHUB_OUTPUT
          echo "service_name=$(terraform output -raw ecs_service_name)" >> $GITHUB_OUTPUT
          echo "alb_dns=$(terraform output -raw alb_dns_name)" >> $GITHUB_OUTPUT
      
      - name: Update ECS Service
        run: |
          aws ecs update-service \
            --cluster ${{ steps.terraform-outputs.outputs.cluster_name }} \
            --service ${{ steps.terraform-outputs.outputs.service_name }} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}
      
      - name: Wait for ECS Service to Stabilize
        run: |
          aws ecs wait services-stable \
            --cluster ${{ steps.terraform-outputs.outputs.cluster_name }} \
            --services ${{ steps.terraform-outputs.outputs.service_name }} \
            --region ${{ env.AWS_REGION }}
      
      - name: Verify Deployment
        run: |
          SERVICE_STATUS=$(aws ecs describe-services \
            --cluster ${{ steps.terraform-outputs.outputs.cluster_name }} \
            --services ${{ steps.terraform-outputs.outputs.service_name }} \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].status' \
            --output text)
          
          if [ "$SERVICE_STATUS" != "ACTIVE" ]; then
            echo "âŒ Service is not ACTIVE. Status: $SERVICE_STATUS"
            exit 1
          fi
          
          echo "âœ… Service is ACTIVE"

  # ============================================
  # Run Database Migrations
  # ============================================
  
  run-migrations:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: [deploy-ecs]
    if: always()
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Get ECS Task
        id: get-task
        run: |
          cd terraform
          CLUSTER=$(terraform output -raw ecs_cluster_name)
          TASK_ARN=$(aws ecs list-tasks \
            --cluster $CLUSTER \
            --service-name ${{ steps.terraform-outputs.outputs.service_name }} \
            --desired-status RUNNING \
            --query 'taskArns[0]' \
            --output text)
          
          echo "task_arn=$TASK_ARN" >> $GITHUB_OUTPUT
      
      - name: Run Prisma Migrations
        run: |
          cd terraform
          CLUSTER=$(terraform output -raw ecs_cluster_name)
          TASK_ARN=${{ steps.get-task.outputs.task_arn }}
          
          aws ecs execute-command \
            --cluster $CLUSTER \
            --task $TASK_ARN \
            --container portfolio-app \
            --command "npx prisma migrate deploy" \
            --interactive \
            --region ${{ env.AWS_REGION }}

  # ============================================
  # Post-deployment Verification
  # ============================================
  
  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-ecs]
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Get ALB DNS
        id: alb
        run: |
          cd terraform
          echo "dns=$(terraform output -raw alb_dns_name)" >> $GITHUB_OUTPUT
      
      - name: Health Check
        run: |
          ALB_DNS=${{ steps.alb.outputs.dns }}
          MAX_RETRIES=30
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s "http://$ALB_DNS/api/health" > /dev/null; then
              echo "âœ… Health check passed"
              exit 0
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Waiting for health check... ($RETRY_COUNT/$MAX_RETRIES)"
            sleep 10
          done
          
          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          exit 1

  # ============================================
  # Deployment Summary
  # ============================================
  
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [verify-deployment, run-migrations]
    if: always()
    
    steps:
      - name: Get deployment info
        id: info
        run: |
          cd terraform
          echo "alb_dns=$(terraform output -raw alb_dns_name)" >> $GITHUB_OUTPUT
          echo "cluster=$(terraform output -raw ecs_cluster_name)" >> $GITHUB_OUTPUT
          echo "service=$(terraform output -raw ecs_service_name)" >> $GITHUB_OUTPUT
      
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ env.ENVIRONMENT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Application URL | http://${{ steps.info.outputs.alb_dns }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ECS Cluster | ${{ steps.info.outputs.cluster }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ECS Service | ${{ steps.info.outputs.service }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | ${{ needs.build-and-push.outputs.image-tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit SHA | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY

