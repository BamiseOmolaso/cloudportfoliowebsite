name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      confirm_deployment:
        description: 'Type "DEPLOY" to confirm production deployment'
        required: true
        type: string

env:
  AWS_REGION: us-east-1
  ENVIRONMENT: prod
  ECR_REPOSITORY: omolaso-portfolio

jobs:
  # ============================================
  # Pre-deployment Checks (Stricter for Prod)
  # ============================================
  
  pre-deploy-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run pre-deployment script
        run: npm run predeploy
      
      - name: Verify no critical vulnerabilities
        run: |
          npm audit --audit-level=high
          if [ $? -ne 0 ]; then
            echo "âŒ Critical vulnerabilities found. Fix before deploying to production."
            exit 1
          fi

  # ============================================
  # Build & Push Docker Image
  # ============================================
  
  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks]
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=prod-
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
      
      - name: Scan image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.meta.outputs.tags }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
      
      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ============================================
  # Terraform Plan (Requires Approval)
  # ============================================
  
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [build-and-push]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false
      
      - name: Terraform Init
        run: |
          cd terraform
          terraform init
      
      - name: Terraform Plan
        id: plan
        run: |
          cd terraform
          terraform plan \
            -var="environment=${{ env.ENVIRONMENT }}" \
            -out=tfplan
      
      - name: Save Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-prod
          path: terraform/tfplan
          retention-days: 7
      
      - name: Comment PR with Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('terraform/tfplan', 'base64');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Terraform Plan\n\n\`\`\`\n${plan}\n\`\`\``
            });

  # ============================================
  # Manual Approval Gate
  # ============================================
  
  approval:
    name: Production Deployment Approval
    runs-on: ubuntu-latest
    needs: [terraform-plan]
    environment:
      name: production
      url: https://yourdomain.com  # Update with your domain
    
    steps:
      - name: Check manual confirmation
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ github.event.inputs.confirm_deployment }}" != "DEPLOY" ]; then
            echo "âŒ Deployment not confirmed. Type 'DEPLOY' to proceed."
            exit 1
          fi
          echo "âœ… Deployment confirmed"

  # ============================================
  # Deploy Infrastructure
  # ============================================
  
  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [approval]
    environment:
      name: production
      url: https://yourdomain.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
      
      - name: Download Terraform Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-prod
          path: terraform
      
      - name: Terraform Apply
        run: |
          cd terraform
          terraform apply -auto-approve tfplan
      
      - name: Get Terraform Outputs
        id: terraform-outputs
        run: |
          cd terraform
          echo "ecr_url=$(terraform output -raw ecr_repository_url)" >> $GITHUB_OUTPUT
          echo "cluster_name=$(terraform output -raw ecs_cluster_name)" >> $GITHUB_OUTPUT
          echo "service_name=$(terraform output -raw ecs_service_name)" >> $GITHUB_OUTPUT
          echo "alb_dns=$(terraform output -raw alb_dns_name)" >> $GITHUB_OUTPUT

  # ============================================
  # Deploy Application (Blue-Green Strategy)
  # ============================================
  
  deploy-ecs:
    name: Deploy to ECS (Blue-Green)
    runs-on: ubuntu-latest
    needs: [terraform-apply, build-and-push]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Get Terraform Outputs
        id: terraform-outputs
        run: |
          cd terraform
          echo "cluster_name=$(terraform output -raw ecs_cluster_name)" >> $GITHUB_OUTPUT
          echo "service_name=$(terraform output -raw ecs_service_name)" >> $GITHUB_OUTPUT
          echo "alb_dns=$(terraform output -raw alb_dns_name)" >> $GITHUB_OUTPUT
      
      - name: Update ECS Service
        run: |
          aws ecs update-service \
            --cluster ${{ steps.terraform-outputs.outputs.cluster_name }} \
            --service ${{ steps.terraform-outputs.outputs.service_name }} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}
      
      - name: Wait for ECS Service to Stabilize
        run: |
          aws ecs wait services-stable \
            --cluster ${{ steps.terraform-outputs.outputs.cluster_name }} \
            --services ${{ steps.terraform-outputs.outputs.service_name }} \
            --region ${{ env.AWS_REGION }} \
            --max-attempts 60
      
      - name: Verify Deployment
        run: |
          SERVICE_STATUS=$(aws ecs describe-services \
            --cluster ${{ steps.terraform-outputs.outputs.cluster_name }} \
            --services ${{ steps.terraform-outputs.outputs.service_name }} \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].status' \
            --output text)
          
          RUNNING_COUNT=$(aws ecs describe-services \
            --cluster ${{ steps.terraform-outputs.outputs.cluster_name }} \
            --services ${{ steps.terraform-outputs.outputs.service_name }} \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].runningCount' \
            --output text)
          
          DESIRED_COUNT=$(aws ecs describe-services \
            --cluster ${{ steps.terraform-outputs.outputs.cluster_name }} \
            --services ${{ steps.terraform-outputs.outputs.service_name }} \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].desiredCount' \
            --output text)
          
          if [ "$SERVICE_STATUS" != "ACTIVE" ]; then
            echo "âŒ Service is not ACTIVE. Status: $SERVICE_STATUS"
            exit 1
          fi
          
          if [ "$RUNNING_COUNT" -ne "$DESIRED_COUNT" ]; then
            echo "âŒ Not all tasks are running. Running: $RUNNING_COUNT, Desired: $DESIRED_COUNT"
            exit 1
          fi
          
          echo "âœ… Service is ACTIVE with $RUNNING_COUNT/$DESIRED_COUNT tasks running"

  # ============================================
  # Run Database Migrations (Production)
  # ============================================
  
  run-migrations:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: [deploy-ecs]
    if: always()
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Get ECS Task
        id: get-task
        run: |
          cd terraform
          CLUSTER=$(terraform output -raw ecs_cluster_name)
          SERVICE=$(terraform output -raw ecs_service_name)
          
          TASK_ARN=$(aws ecs list-tasks \
            --cluster $CLUSTER \
            --service-name $SERVICE \
            --desired-status RUNNING \
            --query 'taskArns[0]' \
            --output text)
          
          echo "task_arn=$TASK_ARN" >> $GITHUB_OUTPUT
          echo "cluster=$CLUSTER" >> $GITHUB_OUTPUT
      
      - name: Run Prisma Migrations
        run: |
          TASK_ARN=${{ steps.get-task.outputs.task_arn }}
          CLUSTER=${{ steps.get-task.outputs.cluster }}
          
          aws ecs execute-command \
            --cluster $CLUSTER \
            --task $TASK_ARN \
            --container portfolio-app \
            --command "npx prisma migrate deploy" \
            --interactive \
            --region ${{ env.AWS_REGION }}

  # ============================================
  # Post-deployment Verification
  # ============================================
  
  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-ecs]
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Get ALB DNS
        id: alb
        run: |
          cd terraform
          echo "dns=$(terraform output -raw alb_dns_name)" >> $GITHUB_OUTPUT
      
      - name: Health Check
        run: |
          ALB_DNS=${{ steps.alb.outputs.dns }}
          MAX_RETRIES=30
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://$ALB_DNS/api/health" || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Health check passed"
              exit 0
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Waiting for health check... ($RETRY_COUNT/$MAX_RETRIES) - HTTP $HTTP_CODE"
            sleep 10
          done
          
          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          exit 1
      
      - name: Smoke Tests
        run: |
          ALB_DNS=${{ steps.alb.outputs.dns }}
          
          # Test homepage
          curl -f -s "http://$ALB_DNS" > /dev/null || (echo "âŒ Homepage failed" && exit 1)
          
          # Test API health
          curl -f -s "http://$ALB_DNS/api/health" > /dev/null || (echo "âŒ Health endpoint failed" && exit 1)
          
          echo "âœ… All smoke tests passed"

  # ============================================
  # Rollback Capability
  # ============================================
  
  rollback:
    name: Rollback (if needed)
    runs-on: ubuntu-latest
    needs: [verify-deployment]
    if: failure()
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Get Previous Task Definition
        id: previous-task
        run: |
          cd terraform
          CLUSTER=$(terraform output -raw ecs_cluster_name)
          SERVICE=$(terraform output -raw ecs_service_name)
          
          PREVIOUS_TASK=$(aws ecs describe-services \
            --cluster $CLUSTER \
            --services $SERVICE \
            --query 'services[0].deployments[?status==`PRIMARY`].taskDefinition' \
            --output text | head -1)
          
          echo "task_def=$PREVIOUS_TASK" >> $GITHUB_OUTPUT
      
      - name: Rollback Service
        run: |
          cd terraform
          CLUSTER=$(terraform output -raw ecs_cluster_name)
          SERVICE=$(terraform output -raw ecs_service_name)
          TASK_DEF=${{ steps.previous-task.outputs.task_def }}
          
          aws ecs update-service \
            --cluster $CLUSTER \
            --service $SERVICE \
            --task-definition $TASK_DEF \
            --region ${{ env.AWS_REGION }}
          
          echo "ðŸ”„ Rolling back to previous task definition..."

  # ============================================
  # Deployment Summary & Notifications
  # ============================================
  
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [verify-deployment, run-migrations]
    if: always()
    
    steps:
      - name: Get deployment info
        id: info
        run: |
          cd terraform
          echo "alb_dns=$(terraform output -raw alb_dns_name)" >> $GITHUB_OUTPUT
          echo "cluster=$(terraform output -raw ecs_cluster_name)" >> $GITHUB_OUTPUT
          echo "service=$(terraform output -raw ecs_service_name)" >> $GITHUB_OUTPUT
      
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ env.ENVIRONMENT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Application URL | http://${{ steps.info.outputs.alb_dns }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ECS Cluster | ${{ steps.info.outputs.cluster }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ECS Service | ${{ steps.info.outputs.service }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | ${{ needs.build-and-push.outputs.image-tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit SHA | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed By | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY

